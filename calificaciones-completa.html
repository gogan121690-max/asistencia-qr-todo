<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#28a745">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Calificaciones QR</title>
    
    <link rel="manifest" href="./manifest-calificaciones.json">
    <link rel="icon" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .sync-online { background: #d4edda; color: #155724; }
        .sync-offline { background: #f8d7da; color: #721c24; }
        .sync-syncing { background: #fff3cd; color: #856404; }
        
        h1 { color: #28a745; font-size: 1.8em; }
        
        .tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            border: none;
            background: #f0f0f0;
            color: #333;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table-wrapper::-webkit-scrollbar { height: 10px; }
        .table-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #28a745; border-radius: 10px; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
        }
        
        thead {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        
        tbody tr:hover { background: #f8f9fa; }
        
        .grade-input {
            width: 80px;
            padding: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .grade-input:focus {
            border-color: #28a745;
        }
        
        .average-cell {
            background: #e7f3ff;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        
        .activity-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .activity-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .activity-card h4 {
            color: #28a745;
            margin-bottom: 5px;
        }
        
        .activity-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover { color: #000; }

        @media (max-width: 768px) {
            h1 { font-size: 1.4em; }
            .header { padding: 15px; }
            .content { padding: 15px; }
            table { font-size: 0.85em; }
            th, td { padding: 8px; }
        }
    </style>
    
    <!-- PWA Support -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Calificaciones QR">
</head>
<body>
    <div class="header">
        <div>
            <h1>üìä Calificaciones QR</h1>
            <p style="color: #666; margin-top: 5px;">Sistema de Evaluaci√≥n y Calificaciones</p>
        </div>
        <div class="sync-status" id="syncStatus">
            <span id="syncIcon">üî¥</span>
            <span id="syncText">Iniciando...</span>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('listas')">üìã Mis Listas</button>
        <button class="tab" onclick="switchTab('actividades')">üìù Actividades</button>
        <button class="tab" onclick="switchTab('calificar')">‚úèÔ∏è Calificar</button>
        <button class="tab" onclick="switchTab('promedios')">üìà Promedios</button>
    </div>

    <div class="content">
        <div id="alert" class="alert"></div>

        <!-- TAB: MIS LISTAS -->
        <div id="tab-listas" class="tab-content active">
            <h2>üìã Mis Listas de Alumnos</h2>
            <p style="color: #666; margin-bottom: 20px;">Listas sincronizadas desde la App de Asistencia</p>
            
            <div id="listasContainer"></div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-radius: 10px;">
                <h3>üí° ¬øC√≥mo obtener listas?</h3>
                <p>Las listas se sincronizan autom√°ticamente desde la <strong>App de Asistencia</strong>.</p>
                <ol style="margin-top: 10px; padding-left: 20px;">
                    <li>Crea listas en la App de Asistencia</li>
                    <li>Agrega alumnos escaneando QR</li>
                    <li>Las listas aparecer√°n aqu√≠ autom√°ticamente</li>
                </ol>
            </div>
        </div>

        <!-- TAB: ACTIVIDADES -->
        <div id="tab-actividades" class="tab-content">
            <h2>üìù Mis Actividades</h2>
            
            <div class="form-group">
                <label>Seleccionar Lista:</label>
                <select id="actividadListaSelect" onchange="loadActividades()">
                    <option value="">-- Selecciona una lista --</option>
                </select>
            </div>

            <div id="actividadesSection" style="display:none;">
                <button class="btn" onclick="showNuevaActividadModal()">‚ûï Nueva Actividad</button>
                
                <div id="actividadesList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- TAB: CALIFICAR -->
        <div id="tab-calificar" class="tab-content">
            <h2>‚úèÔ∏è Asignar Calificaciones</h2>
            
            <div class="form-group">
                <label>Seleccionar Lista:</label>
                <select id="calificarListaSelect" onchange="loadActividadesParaCalificar()">
                    <option value="">-- Selecciona una lista --</option>
                </select>
            </div>

            <div id="calificarSection" style="display:none;">
                <div class="form-group">
                    <label>Seleccionar Actividad:</label>
                    <select id="actividadSelect" onchange="showQRScannerForGrading()">
                        <option value="">-- Selecciona una actividad --</option>
                    </select>
                </div>

                <div id="qrScannerSection" style="display:none; margin: 30px 0;">
                    <!-- Campo para Esc√°ner USB -->
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #1976d2;">üñ®Ô∏è Esc√°ner USB / Lector de C√≥digo</h3>
                        <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #666;">Haz click en el campo y escanea con tu lector USB</p>
                        <input type="text" 
                            id="usbScannerInputCalificaciones" 
                            placeholder="Click aqu√≠ y escanea con tu lector USB..." 
                            style="width: 100%; padding: 15px; font-size: 1.1em; border: 3px solid #1976d2; border-radius: 5px; text-align: center; font-weight: bold;"
                            autocomplete="off">
                    </div>

                    <!-- Separador -->
                    <div style="text-align: center; margin: 20px 0;">
                        <p style="color: #999; font-weight: bold;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ O usa la C√°mara ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</p>
                    </div>

                    <h3 style="text-align:center; color:#28a745;">üì∑ Escanea QR del Alumno</h3>
                    <div id="readerCalificar" style="width: 100%; max-width: 500px; margin: 20px auto;"></div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                        <button class="btn" id="startCalificarBtn" onclick="startCalificarScanner()">‚ñ∂Ô∏è Iniciar C√°mara</button>
                        <button class="btn btn-secondary" id="stopCalificarBtn" onclick="stopCalificarScanner()" disabled>‚èπÔ∏è Detener</button>
                    </div>

                    <div id="currentStudentInfo" style="display:none; background:#e7f3ff; padding:25px; border-radius:15px; margin:20px 0; border: 3px solid #28a745;">
                        <h3 style="color:#28a745; margin-bottom:15px;">üë§ Alumno Escaneado:</h3>
                        <p id="studentName" style="font-size:1.3em; font-weight:bold; color:#333; margin-bottom:10px;"></p>
                        <p id="studentInfo" style="color:#666; font-size:1.1em; margin-bottom:5px;"></p>
                        <p id="currentGrade" style="color:#28a745; font-weight:bold; font-size:1.1em;"></p>
                        
                        <h4 style="margin-top:25px; margin-bottom:15px; color:#333;">‚úèÔ∏è Selecciona Calificaci√≥n:</h4>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                            <button class="btn btn-warning" onclick="asignarCalificacion(0)" style="font-size:1.3em; padding:20px 35px; min-width:120px;">N/P<br><small>(0)</small></button>
                            <button class="btn" onclick="asignarCalificacion(8)" style="font-size:1.3em; padding:20px 35px; min-width:120px; background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);">8</button>
                            <button class="btn btn-success" onclick="asignarCalificacion(9)" style="font-size:1.3em; padding:20px 35px; min-width:120px;">9</button>
                            <button class="btn btn-success" onclick="asignarCalificacion(10)" style="font-size:1.3em; padding:20px 35px; min-width:120px; background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);">10</button>
                        </div>
                    </div>
                </div>

                <div id="calificacionesTable" style="margin-top:30px;"></div>
            </div>
        </div>

        <!-- TAB: PROMEDIOS -->
        <div id="tab-promedios" class="tab-content">
            <h2>üìà Tabla de Promedios</h2>
            
            <div class="form-group">
                <label>Seleccionar Lista:</label>
                <select id="promediosListaSelect" onchange="loadPromedios()">
                    <option value="">-- Selecciona una lista --</option>
                </select>
            </div>

            <div id="promediosSection" style="display:none;">
                <button class="btn btn-success" onclick="exportPromediosToExcel()">üì• Exportar a Excel</button>
                <div class="table-wrapper">
                    <div id="promediosTable"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Actividad -->
    <div id="nuevaActividadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNuevaActividadModal()">&times;</span>
            <h2>Nueva Actividad</h2>
            <div class="form-group">
                <label>T√≠tulo:</label>
                <input type="text" id="actividadTitulo" placeholder="Ej: Examen Unidad 1">
            </div>
            <div class="form-group">
                <label>Descripci√≥n (Opcional):</label>
                <textarea id="actividadDescripcion" rows="3" placeholder="Ej: Evaluaci√≥n del primer parcial"></textarea>
            </div>
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="actividadFecha">
            </div>
            <div class="form-group">
                <label>Valor/Puntos:</label>
                <input type="number" id="actividadValor" placeholder="100" min="0" max="100" value="100">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="crearActividad()">‚úÖ Crear</button>
                <button class="btn btn-secondary" onclick="closeNuevaActividadModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script src="./calificaciones-functions.js"></script>
    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDSKcyeDVOZRw2CkMrGapYymdguYllJta4",
            authDomain: "asistencia-qr-38271.firebaseapp.com",
            projectId: "asistencia-qr-38271",
            storageBucket: "asistencia-qr-38271.firebasestorage.app",
            messagingSenderId: "749102163562",
            appId: "1:749102163562:web:101593e4fcb6cccbafcc13"
        };

        let db;
        let isFirebaseEnabled = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Persistencia desactivada para evitar conflictos
            isFirebaseEnabled = true;
            updateSyncStatus('online');
            console.log("‚úÖ Firebase conectado");
        } catch (error) {
            console.warn("‚ö†Ô∏è Firebase no configurado:", error);
            updateSyncStatus('offline');
        }

        let listas = {};
        let actividades = {};
        let calificaciones = {};
        let currentLista = '';

        function updateSyncStatus(status) {
            const statusDiv = document.getElementById('syncStatus');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');
            
            statusDiv.className = 'sync-status';
            
            if (status === 'online') {
                statusDiv.classList.add('sync-online');
                icon.textContent = 'üü¢';
                text.textContent = 'Online - Sincronizado';
            } else if (status === 'offline') {
                statusDiv.classList.add('sync-offline');
                icon.textContent = 'üî¥';
                text.textContent = 'Offline - Sin conexi√≥n';
            } else if (status === 'syncing') {
                statusDiv.classList.add('sync-syncing');
                icon.textContent = 'üü°';
                text.textContent = 'Sincronizando...';
            }
        }

        if (isFirebaseEnabled) {
            window.addEventListener('online', () => {
                updateSyncStatus('syncing');
                setTimeout(() => updateSyncStatus('online'), 2000);
            });
            
            window.addEventListener('offline', () => {
                updateSyncStatus('offline');
            });
        }

        function syncActividadesToFirebase() {
            if (!isFirebaseEnabled) return;
            
            updateSyncStatus('syncing');
            
            Object.keys(actividades).forEach(listaKey => {
                const actividadesLista = actividades[listaKey];
                actividadesLista.forEach(actividad => {
                    const id = `${listaKey}_${actividad.id}`;
                    db.collection('actividades').doc(id).set({
                        ...actividad,
                        lista: listaKey,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(err => console.error("Error sync:", err));
                });
            });
            
            setTimeout(() => updateSyncStatus('online'), 1000);
        }

        function syncCalificacionesToFirebase() {
            if (!isFirebaseEnabled) return;
            
            updateSyncStatus('syncing');
            
            Object.keys(calificaciones).forEach(key => {
                db.collection('calificaciones').doc(key).set({
                    ...calificaciones[key],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => console.error("Error sync:", err));
            });
            
            setTimeout(() => updateSyncStatus('online'), 1000);
        }

        function loadFromFirebase() {
            if (!isFirebaseEnabled) return;
            
            // Cargar listas desde Firebase
            db.collection('listas').onSnapshot((snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    listas[data.nombre] = data.alumnos;
                });
                localStorage.setItem('listas', JSON.stringify(listas));
                displayListas();
                loadListaSelects();
            });
            
            // Cargar actividades
            db.collection('actividades').onSnapshot((snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const listaKey = data.lista;
                    if (!actividades[listaKey]) {
                        actividades[listaKey] = [];
                    }
                    const exists = actividades[listaKey].find(a => a.id === data.id);
                    if (!exists) {
                        actividades[listaKey].push(data);
                    }
                });
                localStorage.setItem('actividades', JSON.stringify(actividades));
            });
            
            // Cargar calificaciones
            db.collection('calificaciones').onSnapshot((snapshot) => {
                snapshot.forEach((doc) => {
                    calificaciones[doc.id] = doc.data();
                });
                localStorage.setItem('calificaciones', JSON.stringify(calificaciones));
            });
        }

        window.addEventListener('load', () => {
            const listasData = localStorage.getItem('listas');
            const actividadesData = localStorage.getItem('actividades');
            const calificacionesData = localStorage.getItem('calificaciones');
            
            if (listasData) listas = JSON.parse(listasData);
            if (actividadesData) actividades = JSON.parse(actividadesData);
            if (calificacionesData) calificaciones = JSON.parse(calificacionesData);
            
            displayListas();
            loadListaSelects();
            
            if (isFirebaseEnabled) {
                loadFromFirebase();
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Detener esc√°ner si est√° activo
            if (window.html5QrcodeCalificar) {
                window.html5QrcodeCalificar.stop().catch(() => {});
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            setTimeout(() => alert.classList.remove('show'), 800); // Reducido a 0.8 segundos
        }

        // Variables para calificaci√≥n
        let html5QrcodeCalificar = null;
        let currentScannedStudent = null;
        let currentCalificarLista = '';
        let currentCalificarActividad = '';
        let scannerActivo = false;

        function showQRScannerForGrading() {
            const actividadId = document.getElementById('actividadSelect').value;
            if (!actividadId) return;
            
            currentCalificarActividad = actividadId;
            document.getElementById('qrScannerSection').style.display = 'block';
            displayCalificacionesTable();
        }

        function startCalificarScanner() {
            console.log('=== INICIANDO ESC√ÅNER ===');
            
            // Validar que hay lista y actividad seleccionadas
            if (!currentCalificarLista || !currentCalificarActividad) {
                showAlert('‚ùå Selecciona una lista y actividad primero', 'error');
                console.log('ERROR: No hay lista o actividad seleccionada');
                return;
            }

            console.log('Lista:', currentCalificarLista);
            console.log('Actividad:', currentCalificarActividad);

            // Si ya hay un esc√°ner activo, detenerlo primero
            if (scannerActivo && html5QrcodeCalificar) {
                console.log('Deteniendo esc√°ner anterior...');
                html5QrcodeCalificar.stop().then(() => {
                    console.log('Esc√°ner anterior detenido');
                    scannerActivo = false;
                    html5QrcodeCalificar = null;
                    setTimeout(() => crearYActivarEscaner(), 500);
                }).catch(err => {
                    console.log('Error al detener esc√°ner anterior:', err);
                    scannerActivo = false;
                    html5QrcodeCalificar = null;
                    crearYActivarEscaner();
                });
            } else {
                crearYActivarEscaner();
            }
        }

        function crearYActivarEscaner() {
            console.log('Creando nueva instancia del esc√°ner...');
            
            html5QrcodeCalificar = new Html5Qrcode("readerCalificar");
            console.log('Instancia creada');

            html5QrcodeCalificar.start(
                { facingMode: "environment" },
                { fps: 20, qrbox: 300 },
                (decodedText) => {
                    console.log('üéØ QR DETECTADO:', decodedText);
                    const data = decodedText.split(',');
                    console.log('Datos parseados:', data);
                    
                    if (data.length >= 6) {
                        console.log('‚úÖ Formato v√°lido');
                        playBeep();
                        handleScannedStudent(data);
                    } else {
                        console.log('‚ùå Formato inv√°lido');
                        showAlert('‚ùå QR inv√°lido', 'error');
                    }
                }
            ).then(() => {
                console.log('‚úÖ Esc√°ner iniciado exitosamente');
                scannerActivo = true;
                document.getElementById('startCalificarBtn').disabled = true;
                document.getElementById('stopCalificarBtn').disabled = false;
            }).catch(err => {
                console.error('‚ùå Error al iniciar esc√°ner:', err);
                showAlert('‚ùå Error: ' + err.message, 'error');
                document.getElementById('startCalificarBtn').disabled = false;
                document.getElementById('stopCalificarBtn').disabled = true;
                scannerActivo = false;
            });
        }

        function stopCalificarScanner() {
            console.log('Deteniendo esc√°ner...');
            if (html5QrcodeCalificar && scannerActivo) {
                html5QrcodeCalificar.stop().then(() => {
                    console.log('Esc√°ner detenido');
                    scannerActivo = false;
                    document.getElementById('startCalificarBtn').disabled = false;
                    document.getElementById('stopCalificarBtn').disabled = true;
                }).catch(err => {
                    console.error('Error al detener:', err);
                    scannerActivo = false;
                    document.getElementById('startCalificarBtn').disabled = false;
                    document.getElementById('stopCalificarBtn').disabled = true;
                });
            }
        }

        function handleScannedStudent(data) {
            const [apellidoPaterno, apellidoMaterno, nombre, grado, grupo, escuela] = data;
            
            currentScannedStudent = {
                apellidoPaterno,
                apellidoMaterno,
                nombre,
                grado,
                grupo,
                escuela
            };

            const fullName = `${apellidoPaterno} ${apellidoMaterno} ${nombre}`;
            document.getElementById('studentName').textContent = fullName;
            document.getElementById('studentInfo').textContent = `Grado: ${grado}¬∞ | Grupo: ${grupo} | Escuela: ${escuela}`;
            
            // Verificar si ya tiene calificaci√≥n
            const key = `${currentCalificarLista}_${currentCalificarActividad}_${fullName}`;
            const existingGrade = calificaciones[key];
            
            if (existingGrade) {
                document.getElementById('currentGrade').textContent = `‚ö†Ô∏è Calificaci√≥n actual: ${existingGrade.calificacion}`;
                document.getElementById('currentGrade').style.display = 'block';
            } else {
                document.getElementById('currentGrade').textContent = '';
                document.getElementById('currentGrade').style.display = 'none';
            }
            
            document.getElementById('currentStudentInfo').style.display = 'block';
            
            // Detener esc√°ner temporalmente
            stopCalificarScanner();
        }

        function asignarCalificacion(calificacion) {
            if (!currentScannedStudent) {
                showAlert('Error: No hay alumno escaneado', 'error');
                return;
            }

            // Obtener valor de la actividad
            const actividadesLista = actividades[currentCalificarLista] || [];
            const actividad = actividadesLista.find(a => a.id === currentCalificarActividad);
            const maxValor = actividad ? actividad.valor : 10;

            // Clave que coincide con loadPromedios
            const key = `${currentCalificarLista}_${currentCalificarActividad}_${currentScannedStudent.nombre}_${currentScannedStudent.apellidoPaterno}_${currentScannedStudent.apellidoMaterno}`;
            const fullName = `${currentScannedStudent.apellidoPaterno} ${currentScannedStudent.apellidoMaterno} ${currentScannedStudent.nombre}`;
            
            const calificacionData = {
                lista: currentCalificarLista,
                actividad: currentCalificarActividad,
                alumno: fullName,
                apellidoPaterno: currentScannedStudent.apellidoPaterno,
                apellidoMaterno: currentScannedStudent.apellidoMaterno,
                nombre: currentScannedStudent.nombre,
                grado: currentScannedStudent.grado,
                grupo: currentScannedStudent.grupo,
                escuela: currentScannedStudent.escuela,
                valor: calificacion,
                maxValor: maxValor,
                calificacion: calificacion,
                fecha: new Date().toLocaleDateString('es-MX'),
                hora: new Date().toLocaleTimeString('es-MX')
            };

            calificaciones[key] = calificacionData;
            localStorage.setItem('calificaciones', JSON.stringify(calificaciones));

            // Guardar en Firebase
            if (isFirebaseEnabled) {
                db.collection('calificaciones').doc(key).set({
                    ...calificacionData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    showAlert(`‚úÖ Calificaci√≥n ${calificacion} asignada a ${fullName}`, 'success');
                }).catch(err => {
                    console.error("Error al guardar:", err);
                    showAlert('‚ö†Ô∏è Guardado localmente, sincronizar√° despu√©s', 'success');
                });
            } else {
                showAlert(`‚úÖ Calificaci√≥n ${calificacion} asignada a ${fullName}`, 'success');
            }

            // Limpiar y mostrar tabla actualizada
            document.getElementById('currentStudentInfo').style.display = 'none';
            currentScannedStudent = null;
            displayCalificacionesTable();
            
            // Enfocar campo USB para siguiente escaneo (en lugar de reiniciar c√°mara)
            setTimeout(() => {
                const usbInput = document.getElementById('usbScannerInputCalificaciones');
                if (usbInput) {
                    usbInput.focus();
                }
            }, 500);
        }

        function displayCalificacionesTable() {
            const container = document.getElementById('calificacionesTable');
            
            // Filtrar calificaciones de esta lista y actividad usando las claves correctas
            const filteredCalificaciones = [];
            
            const alumnos = listas[currentCalificarLista] || [];
            alumnos.forEach(alumno => {
                const key = `${currentCalificarLista}_${currentCalificarActividad}_${alumno.nombre}_${alumno.apellidoPaterno}_${alumno.apellidoMaterno}`;
                if (calificaciones[key]) {
                    filteredCalificaciones.push(calificaciones[key]);
                }
            });

            if (filteredCalificaciones.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No hay calificaciones asignadas a√∫n</p>';
                return;
            }

            let html = '<h3>üìã Calificaciones Asignadas</h3>';
            html += '<div class="table-wrapper"><table><thead><tr>';
            html += '<th>No.</th><th>Nombre Completo</th><th>Calificaci√≥n</th><th>Fecha</th><th>Acciones</th>';
            html += '</tr></thead><tbody>';

            filteredCalificaciones.forEach((cal, idx) => {
                const gradeColor = cal.calificacion === 0 ? '#dc3545' : cal.calificacion === 10 ? '#28a745' : '#ffc107';
                const gradeBg = cal.calificacion === 0 ? '#f8d7da' : cal.calificacion === 10 ? '#d4edda' : '#fff3cd';
                
                html += `<tr>
                    <td>${idx + 1}</td>
                    <td>${cal.alumno}</td>
                    <td style="background:${gradeBg}; color:${gradeColor}; font-weight:bold; font-size:1.2em; text-align:center;">
                        ${cal.calificacion === 0 ? 'N/P' : cal.calificacion}
                    </td>
                    <td>${cal.fecha}</td>
                    <td>
                        <button class="btn btn-small btn-warning" onclick="modificarCalificacion('${cal.nombre}', '${cal.apellidoPaterno}', '${cal.apellidoMaterno}')">‚úèÔ∏è Modificar</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function modificarCalificacion(nombre, apellidoPaterno, apellidoMaterno) {
            const key = `${currentCalificarLista}_${currentCalificarActividad}_${nombre}_${apellidoPaterno}_${apellidoMaterno}`;
            const cal = calificaciones[key];
            
            if (!cal) return;

            // Crear alumno temporal para modificar
            currentScannedStudent = {
                apellidoPaterno: apellidoPaterno,
                apellidoMaterno: apellidoMaterno,
                nombre: nombre,
                grado: cal.grado,
                grupo: cal.grupo,
                escuela: cal.escuela
            };

            const alumnoNombre = `${apellidoPaterno} ${apellidoMaterno} ${nombre}`;
            document.getElementById('studentName').textContent = alumnoNombre;
            document.getElementById('studentInfo').textContent = `Grado: ${cal.grado}¬∞ | Grupo: ${cal.grupo} | Escuela: ${cal.escuela}`;
            document.getElementById('currentGrade').textContent = `Calificaci√≥n actual: ${cal.calificacion === 0 ? 'N/P' : cal.calificacion}`;
            document.getElementById('currentGrade').style.display = 'block';
            document.getElementById('currentStudentInfo').style.display = 'block';

            // Scroll hacia el esc√°ner
            document.getElementById('currentStudentInfo').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ========== ESC√ÅNER USB PARA CALIFICACIONES ==========
        window.addEventListener('DOMContentLoaded', function() {
            const usbInput = document.getElementById('usbScannerInputCalificaciones');
            if (usbInput) {
                usbInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        processUSBScanCalificaciones(this.value.trim());
                        this.value = '';
                    }
                });
                
                let timeout;
                usbInput.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        if (this.value.length > 0) {
                            processUSBScanCalificaciones(this.value.trim());
                            this.value = '';
                        }
                    }, 2000);
                });
            }
        });

        function processUSBScanCalificaciones(text) {
            if (!text || !currentCalificarLista || !currentCalificarActividad) {
                if (!currentCalificarLista || !currentCalificarActividad) {
                    showAlert('‚ùå Selecciona una lista y actividad primero', 'error');
                }
                return;
            }
            
            const data = text.split(',');
            if (data.length === 6) {
                handleScannedStudent(data);
            } else {
                showAlert('‚ùå C√≥digo QR inv√°lido', 'error');
            }
        }

        // ========== FUNCIONES DE SONIDO ==========
        
        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('No se pudo reproducir sonido:', e);
            }
        }
    </script>
    
    <!-- Service Worker para funcionamiento OFFLINE -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado - App funciona OFFLINE');
                    })
                    .catch(error => {
                        console.log('‚ùå Error al registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
